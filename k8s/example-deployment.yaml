---
apiVersion: v1
kind: ConfigMap
metadata:
  name: metrics
  labels:
    app: mfl
    version: "0.3"
data:
  test1.yaml: |
    ---
    metric: test_metric_status_200
    metrichelp: "Тестовая метрика status 200, счётчик"
    metrictype: counter # gauge, histogram, summary
    query: |
        {
            "query": {
                "bool": {
                    "filter": [
                        {
                            "range": {
                                "@timestamp": {
                                    "gte": "{{.Gte}}",
                                    "lte": "{{.Lte}}",
                                    "format": "strict_date_optional_time"
                                }
                            }
                        },
                        {
                            "match_phrase": {
                                "status": 200
                            }
                        }
                    ]
                }
            }
        }
    labels:
        - name: "status"
          value: "200"
    index: "test-index-*"
    repeat: 5
    delay: 4

  test2.yaml: |
    ---
    metric: test_metric_status_400
    metrichelp: "Тестовая метрика status 400, счётчик"
    metrictype: counter # gauge, histogram, summary
    query: |
        {
            "query": {
                "bool": {
                    "filter": [
                        {
                            "range": {
                                "@timestamp": {
                                    "gte": "{{.Gte}}",
                                    "lte": "{{.Lte}}",
                                    "format": "strict_date_optional_time"
                                }
                            }
                        },
                        {
                            "match_phrase": {
                                "status": 400
                            }
                        }
                    ]
                }
            }
        }
    labels:
        - name: "status"
          value: "400"
    index: "test-index-*"
    repeat: 10
    delay: 30
---
kind: Service
apiVersion: v1
metadata:
  name:  mfl
  labels:
    version: "0.3"
spec:
  selector:
    app:  mfl
    version: "0.3"
  type:  ClusterIP
  ports:
  - name:  http
    port:  8080
    targetPort:  8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name:  mfl
  labels:
    name:  mfl
    version: "0.3"
spec:
  replicas: 2
  selector:
    matchLabels:
      name:  mfl
      version: "0.3"
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
    type: RollingUpdate
  template:
    metadata:
      labels:
        name:  mfl
        version: "0.3"
    spec:
      containers:
      - image:  bigkaa/mfl:v0.3
        name:  mfl
        imagePullPolicy: IfNotPresent
        env:
        - name: MFL_CONF_DIR
          value: "/etc/mfl/conf.d"       
        - name: MFL_LOG_LEVEL
          value: "debug"
        - name: MFL_BIND_ADDR
          value: "0.0.0.0:8080"
        - name: MFL_CONTEXT
          value: "/mfl"
        - name: MFL_ES_HOST
          value: "http://127.0.0.1"
        - name: MFL_ES_PORT
          value: "9200"
        - name: MFL_ES_USER
          value: "elasticsearch_user"
        - name: MFL_ES_PASSWORD
          value: "elasticsearch_user_password"
        - name: MFL_REDIS_SERVER
          value: "redis.any.body.com"
        - name: MFL_REDIS_PORT
          value: "6379"
        - name: MFL_K8S_POD
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: MFL_K8S_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        resources:
          requests:
            cpu: "0.2"
            memory: "50M"
          limits:
            cpu: "1"
            memory: "200M"
        livenessProbe:
          httpGet:
            path: /mfl/metrics/
            port: 8080
          initialDelaySeconds: 90
          timeoutSeconds: 10
        readinessProbe:
          httpGet:
            path: /mfl/metrics/
            port: 8080
          initialDelaySeconds: 30
          timeoutSeconds: 10
        ports:
        - containerPort:  8080
          name:  http
        volumeMounts:
          - name:  metrics
            mountPath: /etc/mfl/conf.d/
      restartPolicy: Always
      volumes:
        - name:  metrics
          configMap: 
            name: metrics